Velocity Control Loop Tuning
============================

With the motor configuration set, the YT Scope project ready, we can now focus on the tuning part of the procedure.

The Velocity Control Loop will be managed by the EL7342, the input velocity is managed by the NC. We will first focus on the EL7342 tuning.

.. warning:: 

   REMINDER :  you  The tuning can be affected by the cycle time associated to the NC. It is recommended  to set this task to 1 ms before any tuning,  for better results and less oscillations.  Go to the "Motor and software configuration" chapter II part 1 to set the correct cycle time.


Configurating the Mode
----------------------

To have our EL7342 working as a velocity control loop, we have to setup some parameters in the Process Data and the CoE Online. Left click on the right Terminal EL7342 (if you have multiple), and go in the Process Data window.

.. image:: img/mode_config.png
   :width: 600

In the Predefined PDO Assignment, select the Velocity control compact with info data. It will turn on all the PDO assignment needed for velocity control  plus the PDO needed for the info data which can be assigned, for instance, to the curent command.


.. image:: img/pdo_assign.png
   :width: 600

In the CoE Online window, look for the Operation mode located in either 8022:01 register if you are using the Channel 1, or 8032:01 if you use the Channel 2. Set the mode to Automatic. In this mode, the EL7342 will automatically be set to the Velocity Control Compact with info data that has been set in the process data.
Activate the new configuration with 

.. image:: img/activate_button.png


Tuning with Ziegler-Nichols
---------------------------

To tune our motor, we will be using the Ziegler-Nichols method. In the CoE Online, at the register 8023:0 or 8033:0 depending on the channel used, you will find the Kp, Ki and Kd factor of the velocity control loop. Respectively, 8023:01 8023:02 and 8023:08 (or 8033:01 8033:02 and 8033:08 if channel 2 is used).

.. image:: img/dcm_8023.png

**Start by setting both Ki and Kd to 0.**

The Ziegler-Nichols method's first step is to find the gain Kp ultimate to which the motor is no longer stable, and start oscillating. 
Increase the Kp factor, **to update the changes, disable and enable again the controller on the NC panel.**

.. image:: img/nc_startup.png

.. warning:: 

    Reminder : A shortcut to the NC panel and NC functions is available on the EL7342 window.
    Common problem : Sometimes, enabling controller by clicking on it will not actually enable the motion. Click instead on All to fix the issue.
    Disabling the motion while the motor is moving will send the Error 16992 (0x4260), click on the Reset button F8 of the NC panel to reset it

Once the changes are updated, go in the function panel :


.. image:: img/function_pan.png

Use the Velo Step Sequence function to send velocity commands to the motor. **This function is the only way to send a Velocity command directly to the module velocity control loop.  Other functions go through the position control loop of the NC and thus, will change the gain Kp ultimate.**

The velocity command is sent to the EL7342 through a 16 bits integer (with one bit for the sign). The NC task is using the reference velocity parameter to scale the input velocity (in user units) to the 16 bits velocity command :
e.g. if the reference velocity is 2 mm/s and a command of 1mm/2 is triggered, the NC task will send a command of  $2^15/2 = 16384$ . 

Create a YT chart to display both the actual velocity and the set velocity to visualize your motor's behavior.

.. figure:: img/scope1.png

    *Actual Velocity* (blue)  and *Set Velocity* (green) in mm/s of an oscillating motor M112-2DG1 on a YT Chart on a Velo Step Sequence function

In our example, the motor started being unstable at Kp = 1200. Our gain Kp ultimate (Ku) is 1200.
Using the YT Chart, zoom on the oscillations to measure the oscillation frequency.
Reminder : Use the zoom tool to zoom on the oscillations and click it once to do an automatic Y zoom !

.. figure:: img/scope2.png

   Zoomed in  *Actual Velocity* (blue)  and *Set Velocity* (green) in mm/s of an oscillating motor M112-2DG1 on a YT Chart on a Velo Step Sequence function


.. tip::
   
    You can click on the the tip of two oscillations to read the time t !

    *Actual Velocity* (blue)  and *Set Velocity* (green) in mm/s of an oscillating motor M112-2DG1 on a YT Chart on a Velo Step Sequence function



